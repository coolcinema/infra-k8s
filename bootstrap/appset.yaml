apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: coolcinema-microservices
  namespace: argocd
spec:
  # Включаем Go Templates для поддержки функций (toJson)
  goTemplate: true

  generators:
    - git:
        repoURL: https://github.com/coolcinema/core.git
        revision: main
        files:
          - path: "packages/contracts/apps/*.json"

  template:
    metadata:
      name: "{{.path.filenameNormalized}}"
    spec:
      project: default
      source:
        repoURL: https://github.com/coolcinema/infra-k8s.git
        targetRevision: main
        path: charts/microservice

        helm:
          # 1. Основные значения из CLI (Core): Порты, Ингресс, Имя образа
          values: |
            fullnameOverride: "{{.fullnameOverride}}"
            image:
              repository: "{{.image.repository}}"
            service:
              ports: {{.service.ports | toJson}}
            ingress: {{.ingress | toJson}}
            env: {{.env | toJson}}

          # 2. Переопределения из Infra (CI обновляет теги здесь)
          # Файл лежит в репо infra-k8s (рядом с чартом, в папке apps/)
          valueFiles:
            - "/apps/{{.fullnameOverride}}/values.yaml"

      destination:
        server: https://kubernetes.default.svc
        namespace: coolcinema

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
